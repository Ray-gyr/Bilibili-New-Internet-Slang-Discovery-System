{% extends "layout.html" %}

{% block title %}Browse Dictionary - SlangDiscover{% endblock %}

{% block content %}
<div class="dictionary-container">
    <div class="page-header">
        <h1><i class="fas fa-book"></i> Slang Dictionary</h1>
        <p>Browse and search through approved internet slang terms</p>
    </div>
    
    <!-- Search and filter form -->
    <form method="GET" class="filters">
        <div class="filter-item">
            <label for="search">Search:</label>
            <input type="text" id="search" name="search" value="{{ search }}" placeholder="Enter keyword...">
        </div>
        
        <div class="filter-item">
            <label for="sort_by">Sort By:</label>
            <select id="sort_by" name="sort_by">
                <option value="word" {% if sort_by == 'word' %}selected{% endif %}>Word</option>
                <option value="machine_score" {% if sort_by == 'machine_score' %}selected{% endif %}>Machine Score</option>
                <option value="human_score" {% if sort_by == 'human_score' %}selected{% endif %}>Human Score</option>
                <option value="tfidf" {% if sort_by == 'tfidf' %}selected{% endif %}>TF-IDF</option>
                <option value="pmi" {% if sort_by == 'pmi' %}selected{% endif %}>PMI</option>
            </select>
        </div>
        
        <div class="filter-item">
            <label for="sort_order">Order:</label>
            <select id="sort_order" name="sort_order">
                <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
                <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
            </select>
        </div>
        
        <button type="submit" class="btn btn-primary">Apply Filters</button>
    </form>
    
    <!-- Words table -->
    <table class="words-table">
        <thead>
            <tr>
                <th class="col-id">ID</th>
                <th class="col-word">Word</th>
                <th class="col-machine">Machine Score</th>
                <th class="col-human">Human Score</th>
                <th class="col-tfidf">TF-IDF</th>
                <th class="col-pmi">PMI</th>
                <th class="col-actions">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for word in words %}
            <tr>
                <td class="col-id">{{ word.id }}</td>
                <td class="col-word">{{ word.word }}</td>
                <td class="col-machine">{{ "%.2f"|format(word.machine_score) if word.machine_score else 'N/A' }}</td>
                <td class="col-human">{{ "%.2f"|format(word.human_score) if word.human_score is not none else 'N/A' }}</td>
                <td class="col-tfidf">{{ "%.4f"|format(word.tfidf) if word.tfidf else 'N/A' }}</td>
                <td class="col-pmi">{{ "%.4f"|format(word.pmi) if word.pmi else 'N/A' }}</td>
                <td class="col-actions">
                    <button class="btn btn-sm btn-primary" onclick="showWordDetail({{word.id}})">
                        <i class="fas fa-eye"></i> Details
                    </button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" style="text-align: center; padding: 20px;">
                    No approved words found matching the criteria
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="{{ url_for('browse_dictionary', page=page-1, search=search, sort_by=sort_by, sort_order=sort_order) }}">&laquo; Previous</a>
        {% endif %}
        
        {% set page_range = 2 %}
        {% set start_page = [1, page - page_range]|max %}
        {% set end_page = [total_pages, page + page_range]|min %}
        
        {% if start_page > 1 %}
        <a href="{{ url_for('browse_dictionary', page=1, search=search, sort_by=sort_by, sort_order=sort_order) }}">1</a>
        {% if start_page > 2 %}
        <span class="ellipsis">...</span>
        {% endif %}
        {% endif %}
        
        {% for p in range(start_page, end_page + 1) %}
        {% if p == page %}
        <span class="current">{{ p }}</span>
        {% else %}
        <a href="{{ url_for('browse_dictionary', page=p, search=search, sort_by=sort_by, sort_order=sort_order) }}">{{ p }}</a>
        {% endif %}
        {% endfor %}
        
        {% if end_page < total_pages %}
        {% if end_page < total_pages - 1 %}
        <span class="ellipsis">...</span>
        {% endif %}
        <a href="{{ url_for('browse_dictionary', page=total_pages, search=search, sort_by=sort_by, sort_order=sort_order) }}">{{ total_pages }}</a>
        {% endif %}
        
        {% if page < total_pages %}
        <a href="{{ url_for('browse_dictionary', page=page+1, search=search, sort_by=sort_by, sort_order=sort_order) }}">Next &raquo;</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Word detail modal -->
<div id="wordDetailModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="wordDetailContent">
            <!-- Content will be loaded dynamically via JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .dictionary-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .page-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
        text-align: center;
    }
    
    .page-header h1 {
        color: var(--primary);
        margin-bottom: 10px;
    }
    
    .page-header p {
        color: #666;
        max-width: 600px;
    }
    
    .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
    }
    
    .filter-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-item label {
        font-weight: bold;
        white-space: nowrap;
    }
    
    input, select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background: var(--secondary);
        color: white;
    }
    
    .btn-primary:hover {
        background: var(--primary);
    }
    
    .btn-sm {
        padding: 5px 10px;
        font-size: 0.875rem;
    }
    
    .words-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .words-table th, .words-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    
    .words-table th {
        background: #f8f9fa;
        font-weight: bold;
        position: sticky;
        top: 0;
    }
    
    .words-table tr:hover {
        background: #f8f9fa;
    }
    
    /* Improved pagination styles */
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        gap: 5px;
    }
    
    .pagination a, .pagination span {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-decoration: none;
        color: var(--primary);
    }
    
    .pagination a:hover {
        background: #f8f9fa;
    }
    
    .pagination .current {
        background: var(--secondary);
        color: white;
        border-color: var(--secondary);
    }
    
    .pagination .ellipsis {
        padding: 8px 5px;
        border: none;
    }
    
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: black;
    }
    
    .word-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .word-detail-title {
        font-size: 1.5rem;
        color: var(--primary);
        margin: 0;
    }
    
    .word-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .metric-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }
    
    .metric-label {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 5px;
    }
    
    .metric-value {
        font-size: 1.25rem;
        font-weight: bold;
        color: var(--primary);
    }
    
    .sentences-container {
        margin: 20px 0;
    }
    
    .sentence-item {
        background: #f8f9fa;
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 4px;
        border-left: 4px solid var(--accent);
    }
    
    .additional-stats {
        margin: 20px 0;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .stat-item {
        background: #f8f9fa;
        padding: 10px 15px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .stat-label {
        font-weight: bold;
        color: #6c757d;
    }
    
    .stat-value {
        color: var(--primary);
        font-family: monospace;
    }
    
    mark {
        background-color: #ffeb3b;
        padding: 2px 4px;
        border-radius: 3px;
    }
    
    /* Table column width adjustments */
    .col-id { width: 60px; }
    .col-word { width: 150px; }
    .col-machine { width: 120px; }
    .col-human { width: 120px; }
    .col-tfidf { width: 120px; }
    .col-pmi { width: 120px; }
    .col-actions { width: 120px; }
    
    @media (max-width: 768px) {
        .filters {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .words-table {
            font-size: 0.875rem;
        }
        
        .words-table th, .words-table td {
            padding: 8px 10px;
        }
        
        .modal-content {
            width: 95%;
            margin: 10% auto;
        }
        
        /* Responsive column adjustments */
        .col-id, .col-tfidf, .col-pmi {
            display: none;
        }
        
        .col-word { width: auto; }
        .col-machine { width: auto; }
        .col-human { width: auto; }
        .col-actions { width: auto; }
    }
</style>

<script>
    // Show word details
    function showWordDetail(wordId) {
        // Add validation to ensure wordId is valid
        if (!wordId || wordId === "undefined") {
            console.error("Invalid word ID:", wordId);
            alert("Cannot get word details: Invalid word ID");
            return;
        }
        
        fetch(`/admin/word/${wordId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                const word = data.word;
                
                // Build detail HTML
                let html = `
                    <div class="word-detail-header">
                        <h2 class="word-detail-title">${word.word || 'No word text'}</h2>
                    </div>
                    
                    <div class="word-metrics">
                        <div class="metric-card">
                            <div class="metric-label">Machine Score</div>
                            <div class="metric-value">${word.machine_score != null ? word.machine_score.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Human Score</div>
                            <div class="metric-value">${word.human_score != null ? word.human_score.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">TF-IDF</div>
                            <div class="metric-value">${word.tfidf ? word.tfidf.toFixed(4) : 'N/A'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">PMI</div>
                            <div class="metric-value">${word.pmi ? word.pmi.toFixed(4) : 'N/A'}</div>
                        </div>
                    </div>
                `;
                
                // Add example sentences - using labeling.html approach
                if (word.sentences && word.sentences.length > 0) {
                    html += `
                        <div class="sentences-container">
                            <h3>Example Sentences</h3>
                            ${word.sentences.map(s => {
                                // Handle sentence format, could be string or array
                                let sentenceText, startIdx, endIdx;
                                
                                if (Array.isArray(s)) {
                                    // Format: [sentence, start_index, end_index]
                                    sentenceText = s[0];
                                    startIdx = s[1];
                                    endIdx = s[2];
                                    
                                    // Highlight the word part
                                    const highlighted = sentenceText.slice(0, startIdx) + 
                                                      '<mark>' + sentenceText.slice(startIdx, endIdx) + '</mark>' + 
                                                      sentenceText.slice(endIdx);
                                    
                                    return `<div class="sentence-item">${highlighted}</div>`;
                                } else {
                                    // Format: simple string
                                    return `<div class="sentence-item">${s}</div>`;
                                }
                            }).join('')}
                        </div>
                    `;
                } else {
                    html += `<p>No example sentences available</p>`;
                }
                
                // Add other statistical information - using labeling.html approach
                html += `
                    <div class="additional-stats">
                        <h3>Additional Statistics</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-label">log_freq:</span>
                                <span class="stat-value">${word.log_freq || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">leftent:</span>
                                <span class="stat-value">${word.leftent || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">rightent:</span>
                                <span class="stat-value">${word.rightent || 'N/A'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">hot_video_ratio:</span>
                                <span class="stat-value">${word.hot_video_ratio || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('wordDetailContent').innerHTML = html;
                document.getElementById('wordDetailModal').style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to get word details: ' + error.message);
            });
    }
    
    // Close modal
    function closeModal() {
        document.getElementById('wordDetailModal').style.display = 'none';
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('wordDetailModal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
{% endblock %}