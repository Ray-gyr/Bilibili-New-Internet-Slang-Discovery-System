{% extends "layout.html" %}

{% block title %}Trending Slang - SlangDiscover{% endblock %}

{% block content %}
<div class="trending-container">
    <div class="page-header">
        <h1><i class="fas fa-fire"></i> Trending Slang</h1>
        <p>Explore the most popular internet slang terms based on frequency data</p>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label for="maxWords">Max Words:</label>
            <input type="range" id="maxWords" min="20" max="200" value="100">
            <span id="maxWordsValue">100</span>
        </div>
        
        <div class="control-group">
            <label for="minFrequency">Min Frequency:</label>
            <input type="range" id="minFrequency" min="0" max="10" value="0" step="0.1">
            <span id="minFrequencyValue">0.0</span>
        </div>
        
        <button id="refreshBtn" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
    
    <div class="wordcloud-container">
        <div id="wordcloud"></div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading trending slang data...</p>
        </div>
        <div id="error" class="error-message" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Failed to load trending data. Please try again later.</p>
        </div>
    </div>
    
    <div class="info-panel">
        <h3>About This Visualization</h3>
        <p>This word cloud displays the most popular internet slang terms based on their frequency in our dataset. 
           The size of each word corresponds to its <code>log_freq</code> value, representing how frequently 
           the term appears across comments and discussions.</p>
        <p>Use the controls above to adjust the number of words displayed and filter by minimum frequency.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include WordCloud2.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>

<style>
    .trending-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .page-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }
    
    .page-header h1 {
        color: var(--primary);
        margin-bottom: 10px;
    }
    
    .page-header p {
        color: #666;
        max-width: 600px;
        margin: 0 auto;
    }
    
    .controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
        align-items: center;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }
    
    .control-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .control-group label {
        font-weight: bold;
        white-space: nowrap;
    }
    
    input[type="range"] {
        width: 150px;
    }
    
    .wordcloud-container {
        position: relative;
        width: 100%;
        height: 500px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        overflow: hidden;
    }
    
    #wordcloud {
        width: 100%;
        height: 100%;
    }
    
    .loading, .error-message {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(255,255,255,0.9);
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--secondary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message {
        color: #dc3545;
    }
    
    .error-message i {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    .info-panel {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid var(--accent);
    }
    
    .info-panel h3 {
        color: var(--primary);
        margin-bottom: 10px;
    }
    
    .info-panel p {
        margin-bottom: 10px;
        line-height: 1.6;
    }
    
    .info-panel code {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
    }
    
    @media (max-width: 768px) {
        .controls {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .wordcloud-container {
            height: 400px;
        }
    }
</style>

<script>
    // Global variables
    let wordCloudInstance = null;
    let currentWords = [];
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Set up event listeners for controls
        document.getElementById('maxWords').addEventListener('input', function() {
            document.getElementById('maxWordsValue').textContent = this.value;
        });
        
        document.getElementById('minFrequency').addEventListener('input', function() {
            document.getElementById('minFrequencyValue').textContent = parseFloat(this.value).toFixed(1);
        });
        
        document.getElementById('refreshBtn').addEventListener('click', function() {
            loadWordCloud();
        });
        
        // Initial load
        loadWordCloud();
    });
    
    // Load word cloud data and render
    function loadWordCloud() {
        const maxWords = parseInt(document.getElementById('maxWords').value);
        const minFrequency = parseFloat(document.getElementById('minFrequency').value);
        
        // Show loading state
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('error').style.display = 'none';
        document.getElementById('wordcloud').innerHTML = '';
        
        fetch(`/api/trending_words?max_words=${maxWords}&min_freq=${minFrequency}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                
                if (data.words && data.words.length > 0) {
                    currentWords = data.words;
                    renderWordCloud();
                } else {
                    document.getElementById('wordcloud').innerHTML = 
                        '<div style="text-align: center; padding: 50px; color: #666;">No trending words found matching the criteria</div>';
                }
            })
            .catch(error => {
                console.error('Error loading trending words:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'flex';
            });
    }
    
    // Render the word cloud
    function renderWordCloud() {
        const container = document.getElementById('wordcloud');
        
        // Clear previous word cloud if exists
        if (wordCloudInstance) {
            // WordCloud2.js doesn't have a proper destroy method, so we clear the container
            container.innerHTML = '';
        }
        
        // Prepare data for word cloud
        const wordList = currentWords.map(word => [word.word, word.log_freq]);
        
        // Generate random colors for words
        const colors = [
            '#354f52', '#52796f', '#84a98c', '#2f3e46', 
            '#6b9080', '#a4c3b2', '#cce3de', '#eaf4f4'
        ];
        
        // Calculate min and max frequencies for scaling
        const frequencies = currentWords.map(w => w.log_freq);
        const minFreq = Math.min(...frequencies);
        const maxFreq = Math.max(...frequencies);
        
        // Create word cloud
        try {
            WordCloud(container, {
                list: wordList,
                gridSize: Math.round(16 * container.offsetWidth / 1024),
                weightFactor: function(size) {
                    // Scale the size based on frequency range
                    return Math.max(10, (size - minFreq) / (maxFreq - minFreq) * 70 + 10);
                },
                fontFamily: 'Arial, sans-serif',
                color: function() {
                    // Return random color from our palette
                    return colors[Math.floor(Math.random() * colors.length)];
                },
                rotateRatio: 0.5,
                rotationSteps: 2,
                backgroundColor: '#ffffff',
                drawOutOfBound: false,
                shrinkToFit: true,
                shape: 'circle',
                ellipticity: 0.65,
                hover: function(item, dimension, event) {
                    // Show tooltip on hover
                    if (!item) return;
                    
                    const tooltip = document.getElementById('wordcloud-tooltip');
                    if (tooltip) {
                        tooltip.innerHTML = `
                            <strong>${item[0]}</strong><br>
                            Frequency: ${item[1].toFixed(2)}
                        `;
                        tooltip.style.display = 'block';
                        tooltip.style.left = (event.pageX + 10) + 'px';
                        tooltip.style.top = (event.pageY + 10) + 'px';
                    }
                }
            });
            
            // Add tooltip element if it doesn't exist
            if (!document.getElementById('wordcloud-tooltip')) {
                const tooltip = document.createElement('div');
                tooltip.id = 'wordcloud-tooltip';
                tooltip.style.cssText = `
                    position: absolute;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 14px;
                    pointer-events: none;
                    z-index: 1000;
                    display: none;
                    max-width: 200px;
                `;
                document.body.appendChild(tooltip);
                
                // Hide tooltip when mouse leaves word cloud
                container.addEventListener('mouseleave', function() {
                    tooltip.style.display = 'none';
                });
            }
            
        } catch (error) {
            console.error('Error rendering word cloud:', error);
            document.getElementById('wordcloud').innerHTML = 
                '<div style="text-align: center; padding: 50px; color: #dc3545;">Error rendering word cloud</div>';
        }
    }
    
    // Handle window resize
    window.addEventListener('resize', function() {
        if (currentWords.length > 0) {
            renderWordCloud();
        }
    });
</script>
{% endblock %}